name: RUR2 CI - Build, Verify, and E2E Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published, prereleased ]
  workflow_dispatch:

jobs:
  build_and_verify:
    name: Build Release and Cold Verify
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
        working-directory: .

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        npm install
        cd server && npm install

    - name: Verify required templates exist
      run: |
        echo "==> Checking for required template PDFs"
        ls -la Fixes/pdf_temp_export.pdf
        ls -la Fixes/email_temp_export.pdf
        echo "âœ“ Required templates found"

    - name: Run Phase 0-3 QA
      run: |
        echo "==> Running Phase 0-3 QA"
        bash QA_runner.sh

    - name: Run Phase 4 smoke tests
      run: |
        echo "==> Running Phase 4 smoke tests"
        bash Fixes/qa/phase4_smoke.sh

    - name: Run Phase 5 smoke and E2E tests
      run: |
        echo "==> Running Phase 5 tests"
        bash Fixes/qa/phase5_smoke.sh
        bash Fixes/qa/phase5_e2e.sh

    - name: Build release package
      run: |
        echo "==> Building release package"
        bash phase7_release.sh

    - name: Cold verify package
      run: |
        echo "==> Cold verify latest package"
        LATEST_PKG=$(ls -t releases/rur2_prelaunch_*.tar.gz | head -1)
        echo "Verifying package: $LATEST_PKG"
        bash coldver.sh "$LATEST_PKG"

    - name: Cold verify working tree
      run: |
        echo "==> Cold verify working tree"
        bash coldver.sh

    - name: Verify templates in package
      run: |
        echo "==> Verifying templates are included in package"
        LATEST_PKG=$(ls -t releases/rur2_prelaunch_*.tar.gz | head -1)
        echo "Checking package contents: $LATEST_PKG"
        tar -tzf "$LATEST_PKG" | grep -E "(pdf_temp_export|email_temp_export)" | sort
        echo "âœ“ Templates found in package"

    - name: Run final E2E phases 0-5
      run: |
        echo "==> Running final E2E test (phases 0-5)"
        bash e2e_0_5.sh

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rur2-release-artifacts
        path: |
          releases/*.tar.gz
          Fixes/reports/release_summary.json
          Fixes/reports/qa_run.txt
        retention-days: 30

    - name: Summary
      if: always()
      run: |
        echo "==> CI Summary"
        echo "âœ“ Templates verified in working tree"
        echo "âœ“ Release package built with deterministic template inclusion"
        echo "âœ“ Cold verification passed for both package and working tree"
        echo "âœ“ E2E phases 0-5 completed successfully"
        echo "ðŸŽ‰ All checks passed - RUR2 repo is stable!"
